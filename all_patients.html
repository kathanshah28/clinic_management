<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Patients | Clinic Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8fafc;
      color: #333;
    }

    /* âœ… Keep header exactly same */
    nav.navbar {
      font-family: 'Poppins', sans-serif;
    }

    /* Page title section */
    .page-header {
      text-align: center;
      margin: 40px 0 25px;
    }
    .page-header h2 {
      font-weight: 600;
      color: #222;
    }
    .page-header small {
      color: #6c757d;
    }

    /* Filters Section */
    .filters {
      background: #ffffff;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      margin-bottom: 25px;
    }
    .filters label {
      font-weight: 500;
      font-size: 14px;
      color: #555;
    }
    .filters select, .filters input {
      border-radius: 8px;
    }

    /* Card & Table */
    .card {
      border: none;
      border-radius: 14px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
      background: #fff;
      overflow: hidden;
    }

    table {
      border-collapse: separate;
      border-spacing: 0 8px;
    }

    th {
      background: #f1f5f9;
      color: #0d6efd;
      font-weight: 600;
      border: none;
      text-transform: uppercase;
      font-size: 13px;
    }

    td {
      background: #ffffff;
      border: none;
      vertical-align: middle;
      font-size: 14px;
      padding: 10px 12px !important;
    }

    tr {
      border-radius: 10px;
      transition: all 0.2s ease;
    }

    tr:hover td {
      background-color: #eef6ff !important;
    }

    .badge-day {
      background-color: #e9f3ff;
      color: #0d6efd;
      border-radius: 20px;
      padding: 4px 10px;
      margin: 2px;
      font-size: 12px;
      display: inline-block;
    }

    /* Footer */
    .footer {
      text-align: center;
      color: #888;
      font-size: 14px;
      margin-top: 50px;
      padding-bottom: 20px;
    }

    /* Table Responsiveness */
    .table-responsive {
      border-radius: 12px;
      overflow-x: auto;
    }
  </style>
</head>

<body>
  <!-- âœ… Header unchanged -->
  <nav class="navbar navbar-expand-lg navbar-dark px-4" style="background-color: #007bff;">
    <a class="navbar-brand" href="/">Clinic Dashboard</a>
    <ul class="navbar-nav ms-3">
      <li class="nav-item"><a href="/today" class="nav-link">Today's Patients</a></li>
      <li class="nav-item"><a href="/add" class="nav-link">Add Patient</a></li>
      <li class="nav-item"><a href="/history" class="nav-link active">All Patients</a></li>
    </ul>
  </nav>

  <!-- Page Header -->
  <div class="page-header">
    <h2>All Patients</h2>
    <small id="patientCount">Loading total patients...</small>
  </div>

  <div class="container">
    <!-- ðŸ” Filters -->
    <div class="filters row g-3 align-items-end">
      <div class="col-md-4">
        <label for="searchInput">Search</label>
        <input type="text" id="searchInput" class="form-control" placeholder="Search by name, ID, or number">
      </div>
      <div class="col-md-3">
        <label for="genderFilter">Gender</label>
        <select id="genderFilter" class="form-select">
          <option value="">All</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="conditionFilter">Condition</label>
        <select id="conditionFilter" class="form-select">
          <option value="">All</option>
        </select>
      </div>
      <div class="col-md-2">
        <label for="dayFilter">Visit Day</label>
        <select id="dayFilter" class="form-select">
          <option value="">All</option>
          <option>Monday</option>
          <option>Tuesday</option>
          <option>Wednesday</option>
          <option>Thursday</option>
          <option>Friday</option>
          <option>Saturday</option>
          <option>Sunday</option>
        </select>
      </div>
    </div>

    <!-- Table Card -->
    <div class="card p-3 mb-5">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle text-center" id="patientsTable">
            <thead>
              <tr>
                <th>Patient ID</th>
                <th>Name</th>
                <th>Age</th>
                <th>Gender</th>
                <th>Conditions</th>
                <th>Date of joining</th>
                <th>Number</th>
                <th>Address</th>
                <th>Occupation</th>
                <th>Ref. by</th>
                <th>Time</th>
                <th>Visit Count</th>
                <th>Visit Days</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="13">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">Â© 2025 Clinic Dashboard</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allPatients = [];

    async function loadPatients() {
      try {
        const response = await fetch('/api/patients');
        allPatients = await response.json();
        document.getElementById("patientCount").innerText = `Total Patients: ${allPatients.length}`;
        populateConditionFilter();
        renderTable(allPatients);
      } catch (err) {
        console.error("Error loading patients:", err);
      }
    }

    function populateConditionFilter() {
      const conditions = [...new Set(allPatients.map(p => p.Conditions).filter(Boolean))];
      const select = document.getElementById("conditionFilter");
      conditions.forEach(c => {
        const opt = document.createElement("option");
        opt.textContent = c;
        select.appendChild(opt);
      });
    }

    function renderTable(patients) {
      const tbody = document.querySelector("#patientsTable tbody");
      tbody.innerHTML = "";
      if (patients.length === 0) {
        tbody.innerHTML = `<tr><td colspan="13">No matching patients found</td></tr>`;
        return;
      }

      patients.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.Patient_ID || ''}</td>
          <td>${p.Name || ''}</td>
          <td>${p.Age || ''}</td>
          <td>${p.Gender || ''}</td>
          <td>${p.Conditions || ''}</td>
          <td>${p['Date of joining'] || ''}</td>
          <td>${p.Number || ''}</td>
          <td>${p.Address || ''}</td>
          <td>${p.Occupation || ''}</td>
          <td>${p['Ref.by'] || ''}</td>
          <td>${p.Time || ''}</td>
          <td>${p['Visit Count'] || ''}</td>
          <td>${(p['Visit Days'] || '').split(',').map(d => `<span class="badge-day">${d.trim()}</span>`).join('')}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function applyFilters() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const gender = document.getElementById("genderFilter").value;
      const condition = document.getElementById("conditionFilter").value;
      const day = document.getElementById("dayFilter").value.toLowerCase();

      const filtered = allPatients.filter(p => {
        const matchesSearch =
          p.Name?.toLowerCase().includes(search) ||
          p.Patient_ID?.toString().includes(search) ||
          p.Number?.toString().includes(search);

        const matchesGender = !gender || p.Gender === gender;
        const matchesCondition = !condition || p.Conditions === condition;
        const matchesDay = !day || p['Visit Days']?.toLowerCase().includes(day);

        return matchesSearch && matchesGender && matchesCondition && matchesDay;
      });

      renderTable(filtered);
    }

    document.querySelectorAll("#searchInput, #genderFilter, #conditionFilter, #dayFilter").forEach(el => {
      el.addEventListener("input", applyFilters);
      el.addEventListener("change", applyFilters);
    });

    loadPatients();
  </script>
</body>
</html>
